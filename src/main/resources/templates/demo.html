<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://fonts.googleapis.com/css?family=Roboto:100,300,400,500,700,900" rel="stylesheet">
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" integrity="sha384-JcKb8q3iqJ61gNV9KGb8thSsNjpSL0n8PARn9HuZOnIxN0hoP+VmmDGMN5t9UJ0Z" crossorigin="anonymous">
    <link rel="stylesheet" type="text/css" href="./static/lib/brat/css/style.css"/>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/jqueryui/1.12.1/jquery-ui.min.css" />
    <script src="https://kit.fontawesome.com/cb45cc91b0.js" crossorigin="anonymous"></script>
    <title>COVID-19 Term Detector</title>
    <link href="./static/img/favicon.ico" rel="shortcut icon" type="image/x-icon"/>
    <style>
        /* global setting */
        html,
        body {
            width: 100%;
            height: 100%;
            padding: 0;
            margin: 0;
            font-family: Arial, Helvetica, sans-serif;
        }

        /* for bootstrap */


        /* fix vuetify.js default style */
        .v-treeview--dense .v-treeview-node__root {
            min-height: 24px;
        }

        .container {
            padding: 0;
        }

        /* for brat visualization */
        #fig_bratvis {
            width: 100%;
            min-width: 500px;
            min-height: 280px;
        }
        .brat-vis {
            width: 100%;
            min-width: 500px;
            min-height: 280px;
        }
        #fig_bratvis svg {
            border: 1px solid #efefef;
        }

        /* for this page */
        .pre-output {
            font-size: 10px;
            line-height: 12px;
            max-height: 200px;
            height: 280px;
            border: 1px solid #dddddd;
            overflow-y: auto;
            padding: 5px;
            background: #eeeeee;
        }
    </style>

</head>

<body>
        <!-- Fixed navbar -->
        <nav class="navbar navbar-expand-md navbar-dark fixed-top bg-dark">
            <div class="container">

            <div class="navbar-header">
                <a class="navbar-brand" href="https://covid.cd2h.org/">
                    <img src="https://covid.cd2h.org/sites/default/files/n3c_logo_circle_large.png" alt="n3c_logo" style="width:40px;">
                </a>

                <a class="navbar-brand" href="#">N3C NLP Engine Demo</a>
            </div>

            <div>
                <ul class="navbar-nav mr-auto">
                    <li class="nav-item active"><a class="nav-link" href="#">
                        <i class="fa fa-head-side-mask"></i>
                        COVID-19 Demo <span class="sr-only">(current)</span>
                    </a></li>
                    <li class="nav-item"><a class="nav-link" href="/dict_builder">
                        <i class="fa fa-book-medical"></i>
                        Dictionary Builder
                    </a></li>
                    <li class="nav-item"><a class="nav-link" href="/ie_editor">
                        <i class="fa fa-edit"></i>
                        Rule Editor
                    </a></li>
                    <li class="nav-item"><a class="nav-link" href="https://github.com/OHNLP/N3C-NLP-Documentation/wiki" target="_blank">
                        <i class="fa fa-book"></i>
                        Wiki
                    </a></li>
                </ul>
            </div>

            <div>
                <ul class="navbar-nav mr-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="https://github.com/OHNLP/MedTagger" target="_blank"><i class="fa fa-github"></i> GitHub</a>
                    </li>
                </ul>
            </div>
            </div>

        </nav>

    <div class="container">
        <div class="container-fluid" style="margin-top: 70px; height: calc(100% - 70px);">

            <div class="row">

                <div class="col-md-5">
                    <h5 class="mt-2">Input Text
                        <small>Maximum length: 3,000 characters</small>
                    </h5>
                    <div class="form-group">
                        <textarea id="text" maxlength="3000" width="100%" class="form-control" rows="10">The patient had a dry cough and fever or chills yesterday. He is also experiencing new loss of taste today and three days ago.</textarea>
                    </div>
                    <div class="form-group form-inline">
                        <p>Document Date: <input class="form-control" type="text" id="datepicker" size="30"></p>
                        <button class="btn btn-primary btn-sm" onclick="jarvis.parse();">
                            <i class="fa fa-pencil-alt"></i>
                            Run MedTagger
                        </button>
                    </div>
                </div>


                <div class="col-md-7">

                    <ul class="nav nav-tabs" id="myTab" role="tablist">
                        <li class="nav-item">
                            <a class="nav-link active" id="vis-tab" data-toggle="tab" href="#output_tab_vis" role="tab" aria-controls="output_tab_vis" aria-selected="true">Visualization</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" id="func1-tab" data-toggle="tab" href="#output_tab_func1" role="tab" aria-controls="output_tab_func1" aria-selected="false">Funtion X</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" id="raw-tab" data-toggle="tab" href="#output_tab_rawoutput" role="tab" aria-controls="output_tab_rawoutput" aria-selected="false">Raw Output</a>
                        </li>
                    </ul>

                    <div class="tab-content" id="myTabContent">
                        <div class="tab-pane fade show active" id="output_tab_vis" role="tabpanel" aria-labelledby="vis-tab">
                            <p class="mt-2">Brat visualization</p>
                            <div id="fig_bratvis">
    
                            </div>
                            <p class="mt-2"> Powered by <a href="https://brat.nlplab.org/embed.html" target="_blank">brat</a>. </p>

                        </div>
                        
                        <div class="tab-pane fade" id="output_tab_func1" role="tabpanel" aria-labelledby="func1-tab">
                            <p class="mt-2">Other output content</p>
                            <pre id="output_func1" class="pre-output"></pre>
                        </div>

                        <div class="tab-pane fade" id="output_tab_rawoutput" role="tabpanel" aria-labelledby="raw-tab">
                            <p id="output-msg" class="mt-2">JSON response:</p>
                            <pre id="output_json" class="pre-output"></pre>
                        </div>
                    </div>
                    
                </div>

            </div>
            <!-- /.row -->
            <hr>
            <div class="row">
                <div class="col-md-8">
                    <h4>Concept/Term List</h4>
                    <div class="row">
                        <div class="col-md-4">
                            <ul>
                                <li>Dry cough</li>
                                <li>Fever</li>
                                <li>Lymphopenia</li>
                                <li>Sore Throat</li>
                                <li>Ground Flass Infiltrates</li>
                                <li>Elevated LDH</li>
                                <li>Diarrhea</li>
                                <li>Nasal Congestion</li>
                                <li>Loss of Appetite</li>
                            </ul>
                            <a class="btn btn-secondary"
                               href="https://github.com/OHNLP/MedTagger/tree/master/src/main/resources/medtaggerieresources/covid19"
                               target="_blank" role="button">Ruleset »</a>
                        </div>
                        <div class="col-md-4">
                            <ul>
                                <li>Fatigue</li>
                                <li>Dyspnea</li>
                                <li>Headache</li>
                                <li>Myalgia</li>
                                <li>Abdominal Pain</li>
                                <li>Patchy Infiltrates</li>
                                <li>Elevated PT Time</li>
                                <li>Influenza</li>
                            </ul>

                        </div>
                    </div>

                </div>
                <div class="col-md-4">
                    <h4>COVID-19 Severe Case </h4>
                    <p>To identify people at higher risk for severe illness using structured
                        and unstructured data according to the
                        <a href="https://www.cdc.gov/coronavirus/2019-ncov/need-extra-precautions/people-at-higher-risk.html"
                           target="_blank">CDC guideline</a>.</p>
                    <p><a class="btn btn-secondary"
                          href="https://github.com/OHNLP/N3C-NLP-Documentation/wiki" target="_blank" role="button">Wiki
                        »</a></p>
                </div>
            </div>

            <footer class="my-5 pt-5 text-muted text-center text-small">
                <p class="mb-1">&copy; 2020 Open Health Natural Language Processing (OHNLP) Consortium</p>
                <ul class="list-inline">
                    <li class="list-inline-item"><a href="http://184.73.168.219/index.php/OHNLP:Privacy_policy">Privacy</a>
                    </li>
                    <li class="list-inline-item"><a
                            href="http://184.73.168.219/index.php/OHNLP:General_disclaimer">Disclaimers</a></li>
                    <li class="list-inline-item"><a href="https://github.com/OHNLP/MedTagger/issues">Support</a></li>
                    <li class="list-inline-item"><a href="http://ohnlp.org/">About</a></li>
                </ul>
            </footer>

        </div>


        <div id="toastmsg" class="toast" data-delay="8000" style="position: absolute; top: 20px; right: 20px;">
            <div class="toast-header">
                <i class="fa fa-info-circle"></i>&nbsp;&nbsp;
                <strong class="mr-auto">System Message</strong>
                <!-- <small>11 mins ago</small> -->
                <button type="button" class="ml-2 mb-1 close" data-dismiss="toast" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div id="toastmsg-body" class="toast-body">
                &nbsp;
            </div>
        </div>

        <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/jqueryui/1.12.1/jquery-ui.min.js"></script>

        <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js" integrity="sha384-9/reFTGAW83EW2RDu2S0VKaIzap3H66lZH81PoYlFhbGU+6BZp6G7niu735Sk7lN" crossorigin="anonymous"></script>
        <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js" integrity="sha384-B4gt1jrGC7Jh4AgTPSdUtOBvfO8shuf57BaghqFfPlYxofvL8/KUEfYiJOMMV+rV" crossorigin="anonymous"></script>

        <script src="./static/lib/brat/lib/head.load.min.js"></script>
        <script src="https://www.google.com/recaptcha/api.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/dayjs/1.8.36/dayjs.min.js"></script>
        
        <script>
            var collData = {
                entity_types: [{
                    type: 'Regex',
                    labels: ['Regex'],
                    bgColor: '#7fa2ff',
                    borderColor: 'darken'
                }, {
                    type: "Dict",
                    labels: ['Dict'],
                    bgColor: '#5ea015',
                    borderColor: 'darken'
                }, {
                    type: "Timex3",
                    labels: ['Timex3'],
                    bgColor: '#8f84ec',
                    borderColor: 'darken'
                }],
                entity_attribute_types: [
                    {
                        'type': 'norm',
                        /* brat supports multi-valued attributes, but in our case we will only
                            use a single value and add a glyph to the visualisation to indicate
                            that the entity carries that attribute */
                        'values': {
                        }
                    },
                    {
                        "type": "val",
                        "name": "TimexVal",
                        "values": {
                        }
                    },
                    {
                        "type": "TimexType",
                        "name": "TimexType",
                        "values": {
                            "DATE": {
                                "glyph": "[DATE]",
                            },
                            "TIME": {
                                "glyph": "[TIME]",
                            },
                            "DATETIME": {
                                "glyph": "[DATETIME]",
                            },
                            "DURATION": {
                                "glyph": "[DURATION]",
                            }
                        }
                    },
                    {
                        "values": {
                            "Positive": {
                                // "box": "none",
                                "glyph": "[Positive]",
                                // "dashArray": "1,2" //Incertitude
                            },
                            "Negated": {
                                // "box": "crossed",
                                "glyph": "[Negated]",
                                // "dashArray": "3,4" //Incertitude
                            }
                        },
                        "type": "certainty",
                        "name": "certainty"
                    },
                    {
                        "values": {
                            "Present": {
                                "glyph": "[Present]",
                            },
                            "HistoryOf": {
                                "glyph": "[HistoryOf]",
                            }
                        },
                        "type": "status",
                        "name": "status"
                    },
                    {
                        "values": {
                            "Patient": {
                                "glyph": "[Patient]",
                            },
                            "Others": {
                                "glyph": "[Others]",
                            }
                        },
                        "type": "experiencer",
                        "name": "experiencer"
                    }
                ]
            };

            var fig_bratvis = {
                plot_id: 'fig_bratvis',
                bratLocation: '/static/lib/brat',

                timex2date: function(v, d) {
                    // v is the TPZ#YYYY-MM-DD format date string from result
                    // d is the YYYY-MM-DD format date string of baseline date
                    var date = d;
                    if (v.substring(0, 3) == 'TPZ') {
                        var sign = v.substring(3, 4);
                        var dnum = v.substring(4, 14).split('-');

                        var d_year = parseInt(dnum[0]);
                        var d_month = parseInt(dnum[1]);
                        var d_day = parseInt(dnum[2]);

                        date = dayjs(d);
                        if (sign == '-') {
                            date = date.subtract(d_day, 'day');
                            date = date.subtract(d_month, 'month');
                            date = date.subtract(d_year, 'year');
                        } else {
                            date = date.add(d_day, 'day');
                            date = date.add(d_month, 'month');
                            date = date.add(d_year, 'year');
                        }
                    } else {
                        date = dayjs(v);
                    }
                    return date;
                },

                init: function () {

                    head.js(
                        // External libraries
                        this.bratLocation + '/lib/jquery.min.js',
                        this.bratLocation + '/lib/jquery.svg.min.js',
                        this.bratLocation + '/lib/jquery.svgdom.min.js',

                        // brat helper modules
                        this.bratLocation + '/src/configuration.js',
                        this.bratLocation + '/src/util.js',
                        this.bratLocation + '/src/annotation_log.js',
                        this.bratLocation + '/lib/webfont.js',

                        // brat modules
                        this.bratLocation + '/src/dispatcher.js',
                        this.bratLocation + '/src/url_monitor.js',
                        this.bratLocation + '/src/visualizer.js'
                    );

                    head.ready(function () {
                        // bind to local variable
                        fig_bratvis.Util = Util;

                        //
                        jarvis.msg('inited Brat lib');
                    });
                },

                draw: function (data, doc_date) {
                    // update data
                    this.data = data;
                    this.doc_data = doc_date;

                    // $('#' + this.plot_id).html('');
                    // create a new div
                    var new_div_id = this.plot_id + '_' + (Math.random() * 100000).toFixed(0);

                    $('#' + this.plot_id).html(`
                    <div id="${new_div_id}" class="brat-vis" style="width:100%;">
                    </div>
                    `);

                    // update the collData according to data
                    for (var i = 0; i < data.attributes.length; i++) {
                        var attr = data.attributes[i];
                        var t = attr[1]; // attr type
                        var v = attr[3];
                        if (t == 'norm') {
                            if (collData.entity_attribute_types[0].values.hasOwnProperty(v)) {
                                
                            } else {
                                collData.entity_attribute_types[0].values[v] = {
                                    glyph: "[" + v + "]"
                                };
                            }
                        } else if (t == 'val') {
                            var dt = this.timex2date(v, doc_date);
                            var dt_str = dt.format('YYYY-MM-DD');
                            if (collData.entity_attribute_types[1].values.hasOwnProperty(dt_str)) {
                                
                            } else {
                                collData.entity_attribute_types[1].values[v] = {
                                    glyph: "[" + dt_str + "]"
                                };
                            }
                        }
                    }

                    this.Util.embed(
                        new_div_id,
                        $.extend({}, collData),
                        $.extend({}, data),
                        webFontURLs
                    )
                }
            };


            var webFontURLs = [
                fig_bratvis.bratLocation + '/css/fonts/Astloch-Bold.ttf',
                fig_bratvis.bratLocation + '/css/fonts/PT_Sans-Caption-Web-Regular.ttf',
                fig_bratvis.bratLocation + '/css/fonts/Liberation_Sans-Regular.ttf'
            ];


            var jarvis = {
                url: {
                    parse: '/parse'
                },

                init: function () {
                    fig_bratvis.init();

                    $( "#datepicker" ).datepicker({
                        dateFormat: 'yy-mm-dd'
                    }).datepicker('setDate', new Date());
                },

                parse: function () {
                    // get the text of the doc
                    var doc_text = $('#text').val().trim();
                    if (doc_text == '') {
                        return
                    }

                    // get the date of the doc
                    var doc_date = $('#datepicker').val().trim();

                    // clear the output
                    $('#output-json').html('');

                    // send to backend
                    $.post(
                        this.url.parse,
                        {doc_text: doc_text, doc_date: doc_date},
                        function (data) {
                            console.log(data);
                            jarvis.msg('Parse result: ' + data.success);
                            if (data.success) {
                                jarvis.show(data);
                            } else {
                                $('#output_json').html(data.msg);
                            }
                        }, 'json'
                    )
                },

                show: function (data) {
                    this.data = data;

                    // show return json
                    $('#output_json').html(JSON.stringify(data, null, 2));

                    // show the Brat visualization
                    var doc_date = $('#datepicker').val();
                    if (data.data.hasOwnProperty('doc_date')) {
                        doc_date = data.data.doc_date;
                    }
                    fig_bratvis.draw(data.data, doc_date);

                    // show other things
                },

                msg: function (s) {
                    console.log('* ' + s);
                    toast(s);
                }
            };

            function toast(msg) {
                // $('#toastmsg-body').html(msg);
                // $('#toastmsg').toast('show');
            }

            $(document).ready(function () {
                jarvis.init();
            });
        </script>
    </div>
</body>

</html>